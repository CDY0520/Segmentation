#%% md
## í™˜ê²½ì„¤ì •
#%%
# ==================================================
# í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
# ==================================================

import os
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.colors import to_rgba
import seaborn as sns
import pandas as pd
import scipy.stats as stats
from statsmodels.distributions.empirical_distribution import ECDF
from statsmodels.stats.multitest import multipletests
from scipy.stats import shapiro
from scipy.stats import friedmanchisquare
from scipy.stats import wilcoxon
#%%
# ==================================================
# Google Drive ë§ˆìš´íŠ¸
# ==================================================

from google.colab import drive
drive.mount('/content/drive')
#%% md
## ì „ì—­ë³€ìˆ˜ ì§€ì • ë¨¼ì €!!!!!!!!!!!!!!
#%%
# ==================================================
# ì „ì—­ë³€ìˆ˜ë¥¼ ë¨¼ì € ì§€ì •í•´ì£¼ì„¸ìš” (1) - CSV íŒŒì¼ ê²½ë¡œ
# ==================================================

# CSV íŒŒì¼ì´ ì €ì¥ëœ ê²½ë¡œë¥¼ ì§€ì •í•˜ê³ , ëª¨ë“  íŒŒì¼ëª…ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ì €ì¥í•˜ê³  ì¶”ì¶œ
folder_path = '/content/drive/MyDrive/Colab Notebooks/loss_dice_per_test_images/heart_x_ray'
metrics_path = os.path.join(folder_path, 'individual_metrics')
csv_files = sorted([f for f in os.listdir(metrics_path) if f.endswith('.csv')])

# CSV íŒŒì¼ëª…ì„ dictionaryì˜ keyë¡œ ì €ì¥í•˜ê³  ì¶œë ¥í•˜ê¸°
print(f"\n\nğŸ“ Found {len(csv_files)} CSV file(s) in: '{metrics_path}'\n")
model_file_map = {f: None for f in csv_files}
for f in csv_files:
    print(f"    '{f}': None,")
#%%
# ==================================================
# ì „ì—­ë³€ìˆ˜ë¥¼ ë¨¼ì € ì§€ì •í•´ì£¼ì„¸ìš” (2) - ëª¨ë¸, ë°ì´í„°ì…‹, ì‹œê°í™” ìƒ‰ìƒ
# ==================================================

# ì‚¬ìš©ìê°€ ì§€ì •í•œ ëª¨ë¸ëª…ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ì €ì¥ (model_file_mapì— ì €ì¥ëœ keyì™€ ë§¤ì¹­ë˜ëŠ” ìˆœì„œì— ìœ ì˜)
model_names = [
    'UNet++',
    'Attention UNet',
    'SegFormer',
    'TransUNet'
]

# ë°ì´í„°ì…‹ tag ì§€ì •
dataset_tag = "Heart X-ray"
tag_slug = dataset_tag.lower().replace('-', '_').replace(' ', '_')

# ì‹œê°í™”ì— ì‚¬ìš©ë  ìƒ‰ìƒì„ seaborn íŒ”ë ˆíŠ¸ì—ì„œ ì¶”ì¶œí•˜ì—¬ ëª¨ë¸ë³„ë¡œ ì§€ì •
# viridis
color_list_1 = sns.color_palette("viridis", n_colors=len(model_names))
model_palette_1 = dict(zip(model_names, color_list_1))

# flare
color_list_2 = sns.color_palette("flare", n_colors=len(model_names))
model_palette_2 = dict(zip(model_names, color_list_2))
#%%
# ==================================================
# ì „ì—­ë³€ìˆ˜ë¥¼ ë¨¼ì € ì§€ì •í•´ì£¼ì„¸ìš” (3) - ìë£Œì €ì¥ê²½ë¡œ
# ==================================================

# ì‹œê°í™” ë° í†µê³„ ìë£Œ ì €ì¥ë  ê²½ë¡œ ì„¤ì •
save_viz_dir = os.path.join(folder_path, 'visualizations')
save_stat_dir = os.path.join(folder_path, 'statistics')

# ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±)
os.makedirs(save_viz_dir, exist_ok=True)
os.makedirs(save_stat_dir, exist_ok=True)

print("\n\nğŸ“‚ Save Directory Paths:")
print("    ğŸ“ Visualization folder:", save_viz_dir)
print("    ğŸ“ Statistics folder   :", save_stat_dir)
#%% md
## Dice ë° IoU ë°ì´í„° êµ¬ì„±
#%%
# ==================================================
# CSV íŒŒì¼ëª…ì— ëª¨ë¸ëª… ë§¤í•‘
# ==================================================

# model_nameì„ model_file_mapì˜ valueì— í• ë‹¹
for i, key in enumerate(model_file_map.keys()):
    model_file_map[key] = model_names[i]

# ë§¤í•‘ ê²°ê³¼ ì¶œë ¥
print("\n\n" + "=" * 65)
print("ğŸ“Œ Mapping of CSV filenames to model display names:")
print("=" * 65 + "\n")
print(f"{'CSV File':45} | {'Model Name'}")
print("-" * 65)
for k, v in model_file_map.items():
    print(f"{k:45} | {v}")
#%%
# ==================================================
# Dice, IoUë¼ë¦¬ ë°ì´í„° ë³‘í•©
# ==================================================

# ğŸ“Š ê²°ê³¼ ì €ì¥ìš© ë¦¬ìŠ¤íŠ¸
dice_data = []
iou_data = []

# ğŸ“¥ ëª¨ë“  CSV íŒŒì¼ì—ì„œ Dice, IoU ê°ê° ë¶ˆëŸ¬ì™€ì„œ index ë° model ë¶™ì´ê¸°
for file_name, model_name in model_file_map.items():
    file_path = os.path.join(metrics_path, file_name)

    try:
        df = pd.read_csv(file_path)

        df_dice = pd.DataFrame({
            'image_index': range(len(df)),
            'Model': model_name,
            'Dice': df['Dice']
        })

        df_iou = pd.DataFrame({
            'image_index': range(len(df)),
            'Model': model_name,
            'IoU': df['IoU']
        })

        dice_data.append(df_dice)
        iou_data.append(df_iou)

    except Exception as e:
        print(f"âŒ Error reading {file_name}: {e}")

# ğŸ§± ë³‘í•©
df_dice = pd.concat(dice_data, ignore_index=True)
df_iou = pd.concat(iou_data, ignore_index=True)

for name, df in [('df_dice', df_dice), ('df_iou', df_iou)]:
    print("\n\n" + "=" * 65)
    print(f"ğŸ“‚ Structure of {name}")
    print("=" * 65 + "\n")

    print(f"ğŸ”¢ shape      : {df.shape}")
    print(f"ğŸ“ columns    : {df.columns.tolist()}")

    print("\nğŸ‘€ Preview (Top 5 rows):")
    print(df.head())

    print("\nğŸ”§ Data types:")
    print(df.dtypes)
#%% md
## ìë£Œì €ì¥ ê´€ë ¨ í•¨ìˆ˜
#%%
# ==================================================
# íŒŒì¼ëª… ë²ˆí˜¸ ë¶™ì´ê¸° (ì‹œê°í™” ìë£Œìš©)
# ==================================================

def get_unique_viz_filename(directory, base_filename, extension=".png"):
    """
    ì¤‘ë³µë˜ì§€ ì•ŠëŠ” íŒŒì¼ëª…ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    ì˜ˆ: base_filename="violin_dice_chest_x_ray" â†’
        violin_dice_chest_x_ray.png
        violin_dice_chest_x_ray_001.png
        violin_dice_chest_x_ray_002.png ...
    """
    # ì²« ë²ˆì§¸ í›„ë³´ (ì¤‘ë³µ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    full_path = os.path.join(directory, base_filename + extension)
    if not os.path.exists(full_path):
        return full_path

    # ì¤‘ë³µì´ë©´ _001, _002 ... ë¶™ì´ê¸°
    counter = 1
    while True:
        suffix = f"_{counter:03d}"        # 001, 002, ...
        full_path = os.path.join(directory, f"{base_filename}{suffix}{extension}")
        if not os.path.exists(full_path):
            return full_path
        counter += 1
#%%
# ==================================================
# íŒŒì¼ëª… ë²ˆí˜¸ ë¶™ì´ê¸° (í†µê³„ ìë£Œìš©)
# ==================================================

def get_unique_stat_filename(directory, base_filename, extension=".csv"):
    """
    ì¤‘ë³µë˜ì§€ ì•ŠëŠ” í†µê³„ ê²°ê³¼ íŒŒì¼ëª…ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    ì˜ˆ: base_filename="shapiro_dice_chest_x_ray" â†’
        shapiro_dice_chest_x_ray.csv
        shapiro_dice_chest_x_ray_001.csv
        shapiro_dice_chest_x_ray_002.csv ...
    """
    # ì²« ë²ˆì§¸ í›„ë³´ (ì¤‘ë³µ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    full_path = os.path.join(directory, base_filename + extension)
    if not os.path.exists(full_path):
        return full_path

    # ì¤‘ë³µì´ë©´ _001, _002 ... ë¶™ì´ê¸°
    counter = 1
    while True:
        suffix = f"_{counter:03d}"        # 001, 002, ...
        full_path = os.path.join(directory, f"{base_filename}{suffix}{extension}")
        if not os.path.exists(full_path):
            return full_path
        counter += 1
#%% md
## í†µê³„ë¶„ì„
#%%
# ==================================================
# Shapiro-Wilk test - ì •ê·œë¶„í¬ì—¬ë¶€ í…ŒìŠ¤íŠ¸ (ì†Œê·œëª¨ sample)
# ==================================================

# ì €ì¥ê²½ë¡œ ìƒì„±
file_shapiro_dice = get_unique_stat_filename(save_stat_dir, f"shapiro_dice_{tag_slug}")
file_shapiro_iou  = get_unique_stat_filename(save_stat_dir, f"shapiro_iou_{tag_slug}")

# Dice
results_dice = []
for model in df_dice['Model'].unique():
    vals = df_dice[df_dice['Model'] == model]['Dice']
    stat, p = shapiro(vals)
    results_dice.append({
        'Model': model,
        'W-statistic': stat,
        'p-value (float)': f"{p:.5f}",
        'p-value (sci)': f"{p:.2e}",
        'Normal': 'âœ… Yes' if p > 0.05 else 'âŒ No'
    })

df_normal_dice = pd.DataFrame(results_dice)
df_normal_dice.to_csv(file_shapiro_dice, index=False)

# IoU
results_iou = []
for model in df_iou['Model'].unique():
    vals = df_iou[df_iou['Model'] == model]['IoU']
    stat, p = shapiro(vals)
    results_iou.append({
        'Model': model,
        'W-statistic': stat,
        'p-value (round)': f"{p:.5f}",
        'p-value (sci)': f"{p:.2e}",
        'Normal': 'âœ… Yes' if p > 0.05 else 'âŒ No'
    })

df_normal_iou = pd.DataFrame(results_iou)
df_normal_iou.to_csv(file_shapiro_iou, index=False)

# ê²°ê³¼ í™•ì¸
print("\n\nğŸ“Š Dice normality summary:")
print(df_normal_dice)

print("\n\nğŸ“Š IoU normality summary:")
print(df_normal_iou)

# ì €ì¥
print("\n\nâœ… Shapiro-Wilk results saved:")
print(f"    ğŸ“„ Dice Shapiro-Wilk â†’ {file_shapiro_dice}")
print(f"    ğŸ“„ IoU Shapiro-Wilk  â†’ {file_shapiro_iou}")
#%%
# ==================================================
# Q-Q Plot: Dice & IoU - ì •ê·œì„± ì‹œê°í™”
# ==================================================

# ì €ì¥ê²½ë¡œ ìƒì„±
file_qq_dice = get_unique_viz_filename(save_viz_dir, f"qq_dice_{tag_slug}")
file_qq_iou  = get_unique_viz_filename(save_viz_dir, f"qq_iou_{tag_slug}")

# Dice Box Plot
models = df_dice['Model'].unique()
ncols = 3
nrows = -(-len(models) // ncols)

plt.figure(figsize=(ncols * 4, nrows * 4))
for i, model in enumerate(models, 1):
    plt.subplot(nrows, ncols, i)
    data = df_dice[df_dice['Model'] == model]['Dice']
    stats.probplot(data, dist="norm", plot=plt)
    plt.title(model)
plt.suptitle(f"Q-Q Plots of Dice - {dataset_tag}", fontsize=16)
plt.tight_layout(rect=[0, 0, 1, 0.96])
plt.savefig(file_qq_dice, dpi=300)
plt.show()

# IoU Box Plot
models = df_iou['Model'].unique()
ncols = 3
nrows = -(-len(models) // ncols)

plt.figure(figsize=(ncols * 4, nrows * 4))
for i, model in enumerate(models, 1):
    plt.subplot(nrows, ncols, i)
    data = df_iou[df_iou['Model'] == model]['IoU']
    stats.probplot(data, dist="norm", plot=plt)
    plt.title(model)
plt.suptitle(f"Q-Q Plots of IoU - {dataset_tag}", fontsize=16)
plt.tight_layout(rect=[0, 0, 1, 0.96])
plt.savefig(file_qq_iou, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… Q-Q plots saved successfully:")
print(f"    ğŸ“ Dice Q-Q Plot â†’ {file_qq_dice}")
print(f"    ğŸ“ IoU Q-Q Plot  â†’ {file_qq_iou}")
#%%
# ==================================================
# Friedman Test (3ê°œâ†‘ ëª¨ë¸ ë¹„êµ, ë¹„ëª¨ìˆ˜)
# ==================================================

# ì €ì¥ê²½ë¡œ ìƒì„±
file_friedman = get_unique_stat_filename(save_stat_dir, f"friedman_{tag_slug}")

# Dice pivot
pivot_dice = df_dice.pivot(index='image_index', columns='Model', values='Dice')
scores_dice = [pivot_dice[col].values for col in pivot_dice.columns]
stat_dice, p_dice = friedmanchisquare(*scores_dice)

# IoU pivot
pivot_iou = df_iou.pivot(index='image_index', columns='Model', values='IoU')
scores_iou = [pivot_iou[col].values for col in pivot_iou.columns]
stat_iou, p_iou = friedmanchisquare(*scores_iou)

# ê²°ê³¼ DataFrame ìƒì„±
df_friedman = pd.DataFrame({
    'Metric'     : ['Dice', 'IoU'],
    'Statistic'  : [stat_dice, stat_iou],
    'p-value (round)': [f"{p_dice:.5f}", f"{p_iou:.5f}"],
    'p-value (sci)'  : [f"{p_dice:.2e}", f"{p_iou:.2e}"],
    'Significant': ['âœ… Yes' if p < 0.05 else 'âŒ No' for p in [p_dice, p_iou]]
})
df_friedman.to_csv(file_friedman, index=False)

# ê²°ê³¼ í™•ì¸
print("\n\nğŸ“Š Friedman Test Summary")
print(df_friedman)

# ì €ì¥
print("\n\nâœ… Friedman test results saved:")
print(f"    ğŸ“„ Friedman CSV â†’ {file_friedman}")
#%%
# ==================================================
# Post-hoc Analysis - Wilcoxon Signed-Rank Test
# ==================================================

# ì €ì¥ê²½ë¡œ ìƒì„±
file_wilcoxon_sr_dice = get_unique_stat_filename(save_stat_dir, f"wilcoxon_sr_dice_{tag_slug}")
file_wilcoxon_sr_iou = get_unique_stat_filename(save_stat_dir, f"wilcoxon_sr_iou_{tag_slug}")

# Dice ê¸°ì¤€ Wilcoxon Signed-Rank ì‚¬í›„ë¶„ì„
pivot_dice = df_dice.pivot(index='image_index', columns='Model', values='Dice')
models = pivot_dice.columns.tolist()

results_dice = []
for i in range(len(models)):
    for j in range(i + 1, len(models)):
        a, b = models[i], models[j]
        stat, p = wilcoxon(pivot_dice[a], pivot_dice[b])
        results_dice.append({
            'Model A': a,
            'Model B': b,
            'p-value (float)': p,
            'p-value (sci)': f"{p:.2e}",
            'p-value (round)': f"{p:.5f}"
        })

df_wilcoxon_dice = pd.DataFrame(results_dice)

# ë‹¤ì¤‘ë³´ì • - Dice
_, p_bonf, _, _ = multipletests(df_wilcoxon_dice['p-value (float)'], method='bonferroni')
_, p_holm, _, _ = multipletests(df_wilcoxon_dice['p-value (float)'], method='holm')
_, p_fdr, _, _ = multipletests(df_wilcoxon_dice['p-value (float)'], method='fdr_bh')

df_wilcoxon_dice['Bonferroni p'] = p_bonf
df_wilcoxon_dice['Bonferroni âœ“'] = ['âœ… Yes' if p < 0.05 else 'âŒ No' for p in p_bonf]
df_wilcoxon_dice['Holm p'] = p_holm
df_wilcoxon_dice['Holm âœ“'] = ['âœ… Yes' if p < 0.05 else 'âŒ No' for p in p_holm]
df_wilcoxon_dice['FDR p'] = p_fdr
df_wilcoxon_dice['FDR âœ“'] = ['âœ… Yes' if p < 0.05 else 'âŒ No' for p in p_fdr]

df_wilcoxon_dice.to_csv(file_wilcoxon_sr_dice, index=False)

# IoU ê¸°ì¤€ Wilcoxon Signed-Rank ì‚¬í›„ë¶„ì„
pivot_iou = df_iou.pivot(index='image_index', columns='Model', values='IoU')
models_iou = pivot_iou.columns.tolist()

results_iou = []
for i in range(len(models_iou)):
    for j in range(i + 1, len(models_iou)):
        a, b = models_iou[i], models_iou[j]
        stat, p = wilcoxon(pivot_iou[a], pivot_iou[b])
        results_iou.append({
            'Model A': a,
            'Model B': b,
            'p-value (float)': p,
            'p-value (sci)': f"{p:.2e}",
            'p-value (round)': f"{p:.5f}"
        })

df_wilcoxon_iou = pd.DataFrame(results_iou)

# ë‹¤ì¤‘ë³´ì • - IoU
_, p_bonf_i, _, _ = multipletests(df_wilcoxon_iou['p-value (float)'], method='bonferroni')
_, p_holm_i, _, _ = multipletests(df_wilcoxon_iou['p-value (float)'], method='holm')
_, p_fdr_i, _, _ = multipletests(df_wilcoxon_iou['p-value (float)'], method='fdr_bh')

df_wilcoxon_iou['Bonferroni p'] = p_bonf_i
df_wilcoxon_iou['Bonferroni âœ“'] = ['âœ… Yes' if p < 0.05 else 'âŒ No' for p in p_bonf_i]
df_wilcoxon_iou['Holm p'] = p_holm_i
df_wilcoxon_iou['Holm âœ“'] = ['âœ… Yes' if p < 0.05 else 'âŒ No' for p in p_holm_i]
df_wilcoxon_iou['FDR p'] = p_fdr_i
df_wilcoxon_iou['FDR âœ“'] = ['âœ… Yes' if p < 0.05 else 'âŒ No' for p in p_fdr_i]

df_wilcoxon_iou.to_csv(file_wilcoxon_sr_iou, index=False)

# ê²°ê³¼ í™•ì¸
print("\nğŸ“Š Bonferroni-corrected p-values (Dice):\n")
for a, b, p_raw, p_corr, sig in zip(
    df_wilcoxon_dice['Model A'],
    df_wilcoxon_dice['Model B'],
    df_wilcoxon_dice['p-value (round)'],
    df_wilcoxon_dice['Bonferroni p'],
    df_wilcoxon_dice['Bonferroni âœ“']
):
    print(f"ğŸ”¹ {a} vs {b} â†’ raw: {p_raw}, corrected: {p_corr:.5f}, significant: {sig}")

print("\n\nğŸ“Š Holm-corrected p-values (Dice):\n")
for a, b, p_raw, p_corr, sig in zip(
    df_wilcoxon_dice['Model A'],
    df_wilcoxon_dice['Model B'],
    df_wilcoxon_dice['p-value (round)'],
    df_wilcoxon_dice['Holm p'],
    df_wilcoxon_dice['Holm âœ“']
):
    print(f"ğŸ”¸ {a} vs {b} â†’ raw: {p_raw}, corrected: {p_corr:.5f}, significant: {sig}")

print("\n\nğŸ“Š FDR-corrected p-values (Dice):\n")
for a, b, p_raw, p_corr, sig in zip(
    df_wilcoxon_dice['Model A'],
    df_wilcoxon_dice['Model B'],
    df_wilcoxon_dice['p-value (round)'],
    df_wilcoxon_dice['FDR p'],
    df_wilcoxon_dice['FDR âœ“']
):
    print(f"ğŸŸ¡ {a} vs {b} â†’ raw: {p_raw}, corrected: {p_corr:.5f}, significant: {sig}")

print("\n\nğŸ“Š Bonferroni-corrected p-values (IoU):\n")
for a, b, p_raw, p_corr, sig in zip(
    df_wilcoxon_iou['Model A'],
    df_wilcoxon_iou['Model B'],
    df_wilcoxon_iou['p-value (round)'],
    df_wilcoxon_iou['Bonferroni p'],
    df_wilcoxon_iou['Bonferroni âœ“']
):
    print(f"ğŸ”¹ {a} vs {b} â†’ raw: {p_raw}, corrected: {p_corr:.5f}, significant: {sig}")

print("\n\nğŸ“Š Holm-corrected p-values (IoU):\n")
for a, b, p_raw, p_corr, sig in zip(
    df_wilcoxon_iou['Model A'],
    df_wilcoxon_iou['Model B'],
    df_wilcoxon_iou['p-value (round)'],
    df_wilcoxon_iou['Holm p'],
    df_wilcoxon_iou['Holm âœ“']
):
    print(f"ğŸ”¸ {a} vs {b} â†’ raw: {p_raw}, corrected: {p_corr:.5f}, significant: {sig}")

print("\n\nğŸ“Š FDR-corrected p-values (IoU):\n")
for a, b, p_raw, p_corr, sig in zip(
    df_wilcoxon_iou['Model A'],
    df_wilcoxon_iou['Model B'],
    df_wilcoxon_iou['p-value (round)'],
    df_wilcoxon_iou['FDR p'],
    df_wilcoxon_iou['FDR âœ“']
):
    print(f"ğŸŸ¡ {a} vs {b} â†’ raw: {p_raw}, corrected: {p_corr:.5f}, significant: {sig}")

# ì €ì¥
print("\n\nâœ… Wilcoxon multiple correction results saved successfully:")
print("    ğŸ“„ Dice Wilcoxon multiple correction â†’", file_wilcoxon_sr_dice)
print("    ğŸ“„ IoU  Wilcoxon multiple correction â†’", file_wilcoxon_sr_iou)
#%%
# ==================================================
# Heatmap (p-value matrix)
# ==================================================

def plot_pvalue_heatmap(df_result, metric_name, p_col=None, title_tag=None, heatmap_store_list=None):
    """
    Wilcoxon ì‚¬í›„ë¶„ì„ ê²°ê³¼ë¡œë¶€í„° p-value heatmap ì‹œê°í™” (ë³´ì •ëœ p-value ì‚¬ìš©)

    Parameters:
    - df_result     : DataFrame with columns ['Model A', 'Model B', p_col]
    - metric_name   : str, e.g. 'Dice' or 'IoU'
    - p_col         : str, ë³´ì •ëœ p-value ì»¬ëŸ¼ëª… ('Bonferroni p', 'Holm p', 'FDR p')
    - title_tag     : str, plot ì œëª©ì— ë¶™ì„ ë³´ì • ë°©ì‹ëª…
    - heatmap_store_list: ì €ì¥ëœ íŒŒì¼ ê²½ë¡œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹´ì„ ì™¸ë¶€ list
    """

    # ë¹ˆ ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
    models = sorted(set(df_result['Model A']).union(df_result['Model B']))
    heatmap_data = pd.DataFrame(index=models, columns=models, dtype=float)

    for _, row in df_result.iterrows():
        a, b = row['Model A'], row['Model B']
        p_val = row[p_col]
        heatmap_data.loc[a, b] = p_val
        heatmap_data.loc[b, a] = p_val

    # ì‹œê°í™”
    plt.figure(figsize=(10, 8))
    sns.heatmap(
        heatmap_data.astype(float),
        annot=True, fmt=".3f", cmap="coolwarm_r",
        vmin=0, vmax=0.05,
        linewidths=0.5, square=True, cbar_kws={'label': 'p-value'}
    )
    plt.title(f"Wilcoxon Signed-Rank Post-hoc Analysis ({title_tag} Correction)\n{metric_name} Scores - {dataset_tag}", fontsize=14)
    plt.xticks(rotation=30)
    plt.yticks(rotation=0)
    plt.tight_layout()

    # ì €ì¥ ì˜µì…˜
    file_heatmap = get_unique_viz_filename(save_viz_dir, f"heatmap_{title_tag}_{metric_name.lower()}_{tag_slug}")
    plt.savefig(file_heatmap, dpi=300)
    plt.show()

    if heatmap_store_list is not None:
        heatmap_store_list.append((title_tag, file_heatmap))

# ì €ì¥ê²½ë¡œ ì¶”
heatmap_files_dice = []
heatmap_files_iou = []

# Dice
plot_pvalue_heatmap(df_result=df_wilcoxon_dice, metric_name='Dice', p_col='Bonferroni p', title_tag='Bonferroni', heatmap_store_list=heatmap_files_dice)
plot_pvalue_heatmap(df_result=df_wilcoxon_dice, metric_name='Dice', p_col='Holm p', title_tag='Holm', heatmap_store_list=heatmap_files_dice)
plot_pvalue_heatmap(df_result=df_wilcoxon_dice, metric_name='Dice', p_col='FDR p', title_tag='FDR', heatmap_store_list=heatmap_files_dice)

# IoU
plot_pvalue_heatmap(df_result=df_wilcoxon_iou, metric_name='IoU', p_col='Bonferroni p', title_tag='Bonferroni', heatmap_store_list=heatmap_files_iou)
plot_pvalue_heatmap(df_result=df_wilcoxon_iou, metric_name='IoU', p_col='Holm p', title_tag='Holm', heatmap_store_list=heatmap_files_iou)
plot_pvalue_heatmap(df_result=df_wilcoxon_iou, metric_name='IoU', p_col='FDR p', title_tag='FDR', heatmap_store_list=heatmap_files_iou)

# ì €ì¥
print("\n\nâœ… Heatmaps saved successfully:")
print(f"\n    ğŸ“ Dice Heatmaps:")
for tag, path in heatmap_files_dice:
    print(f"    ğŸ”¹ {tag} â†’ {path}")
print(f"\n    ğŸ“ IoU  Heatmaps:")
for tag, path in heatmap_files_iou:
    print(f"    ğŸ”¸ {tag} â†’ {path}")
#%%
# ==================================================
# Dice & IoU Average Rank
# ==================================================

# ì €ì¥ê²½ë¡œ ìƒì„±
file_avg_rank_dice = get_unique_stat_filename(save_stat_dir, f"avg_rank_dice_{tag_slug}")
file_avg_rank_iou = get_unique_stat_filename(save_stat_dir, f"avg_rank_iou_{tag_slug}")

# ì´ë¯¸ì§€ë³„ ì„±ëŠ¥ Pivot (Dice / IoU)
pivot_dice = df_dice.pivot(index='image_index', columns='Model', values='Dice')
pivot_iou  = df_iou.pivot(index='image_index', columns='Model', values='IoU')

# ì´ë¯¸ì§€ ë‹¨ìœ„ rank ê³„ì‚° (ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ ë” ì¢‹ì€ ìˆœìœ„)
ranks_dice = pivot_dice.rank(axis=1, method='average', ascending=False)
ranks_iou  = pivot_iou.rank(axis=1, method='average', ascending=False)

# ëª¨ë¸ë³„ í‰ê·  rank ê³„ì‚°
mean_ranks_dice = ranks_dice.mean().sort_values()
mean_ranks_iou  = ranks_iou.mean().sort_values()

# ì¶œë ¥
print("\nğŸ“Š Average Ranks (Dice):")
print(mean_ranks_dice)

print("\nğŸ“Š Average Ranks (IoU):")
print(mean_ranks_iou)

# ì €ì¥
mean_ranks_dice.to_csv(file_avg_rank_dice, index=True, header=['Dice_Avg_Rank'])
mean_ranks_iou.to_csv(file_avg_rank_iou, index=True, header=['IoU_Avg_Rank'])

print("\n\nâœ… Average Rank saved successfully:")
print("    ğŸ“ Dice Average Rank â†’", file_avg_rank_dice)
print("    ğŸ“ IoU  Average Rank â†’", file_avg_rank_iou)
#%%
# ==================================================
# Bar Plot: Dice & IoU Average Rank
# ==================================================

# ì €ì¥ê²½ë¡œ ìƒì„±
file_avg_rank_bar_dice = get_unique_viz_filename(save_viz_dir, f"avg_rank_bar_dice_{tag_slug}")
file_avg_rank_bar_iou  = get_unique_viz_filename(save_viz_dir, f"avg_rank_bar_iou_{tag_slug}")

y_pos = np.linspace(0, 1, len(models))

# Dice Average Rank
plt.figure(figsize=(8, 5))
plt.barh(
    y=y_pos,
    width=mean_ranks_dice.values,
    height=0.2,
    color=[to_rgba(model_palette_1[model], alpha=0.4) for model in models]
)
plt.yticks(ticks=y_pos, labels=models)
plt.title(f'Average Rank per Model (Dice) - {dataset_tag}')
plt.xlabel('Average Rank (Lower is Better)')
plt.tight_layout()
for val, y in zip(mean_ranks_dice.values, y_pos):
    plt.text(val - 0.05, y, f"{val:.2f}", va='center', ha='right', color='black', fontsize=10)
plt.show()

# IoU Average Rank
plt.figure(figsize=(8, 5))
plt.barh(
    y=y_pos,
    width=mean_ranks_iou.values,
    height=0.2,
    color=[to_rgba(model_palette_2[model], alpha=0.4) for model in models]
)
plt.yticks(ticks=y_pos, labels=models)
plt.title(f'Average Rank per Model (IoU) - {dataset_tag}')
plt.xlabel('Average Rank (Lower is Better)')
plt.tight_layout()
for val, y in zip(mean_ranks_iou.values, y_pos):
    plt.text(val - 0.05, y, f"{val:.2f}", va='center', ha='right', color='black', fontsize=10)
plt.show()

# ì €ì¥
print("\n\nâœ… Average Rank Bar plots saved successfully:")
print(f"    ğŸ“ Dice Violin Plot â†’ {file_avg_rank_dice}")
print(f"    ğŸ“ IoU  Violin Plot â†’ {file_avg_rank_iou}")
#%% md
## ì •ì„±ì  ì‹œê°í™” ìë£Œ ì¶œë ¥ ë° ì €ì¥
#%%
# ==================================================
# Box Plot: Dice & IoU
# ==================================================

# ì €ì¥ê²½ë¡œ ìƒì„±
file_box_dice = get_unique_viz_filename(save_viz_dir, f"box_dice_{tag_slug}")
file_box_iou  = get_unique_viz_filename(save_viz_dir, f"box_iou_{tag_slug}")

# Dice Box Plot
plt.figure(figsize=(8, 5))
sns.boxplot(
    x='Model', y='Dice', data=df_dice,
    hue='Model', palette=model_palette_1,
    legend=False
)
plt.grid(True, linestyle='--', linewidth=0.7, alpha=0.9)
plt.title(f'Box Plot of Dice Scores - {dataset_tag}')
plt.xticks(rotation=20)
plt.tight_layout()
plt.savefig(file_box_dice, dpi=300)
plt.show()

# IoU Box Plot
plt.figure(figsize=(8, 5))
sns.boxplot(
    x='Model', y='IoU', data=df_iou,
    hue='Model', palette=model_palette_2,
    legend=False
)
plt.grid(True, linestyle='--', linewidth=0.7, alpha=0.9)
plt.title(f'Box Plot of IoU Scores - {dataset_tag}')
plt.xticks(rotation=20)
plt.tight_layout()
plt.savefig(file_box_iou, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… Box plots saved successfully:")
print(f"    ğŸ“ Dice Box Plot â†’ {file_box_dice}")
print(f"    ğŸ“ IoU  Box Plot â†’ {file_box_iou}")
#%%
# ==================================================
# Violin Plot: Dice & IoU
# ==================================================

# ì €ì¥ ê²½ë¡œ ì¤€ë¹„
file_vio_dice = get_unique_viz_filename(save_viz_dir, f"violin_dice_{tag_slug}")
file_vio_iou  = get_unique_viz_filename(save_viz_dir, f"violin_iou_{tag_slug}")

# Dice Violin Plot
plt.figure(figsize=(8, 5))
sns.violinplot(
    x='Model', y='Dice', data=df_dice,
    hue='Model', palette=model_palette_1,
    inner='box', legend=False
)
plt.title(f'Violin Plot of Dice Scores - {dataset_tag}')
plt.xticks(rotation=20)
plt.tight_layout()
plt.savefig(file_vio_dice, dpi=300)
plt.show()

# IoU Violin Plot
plt.figure(figsize=(8, 5))
sns.violinplot(
    x='Model', y='IoU', data=df_iou,
    hue='Model', palette=model_palette_2,
    inner='box', legend=False
)
plt.title(f'Violin Plot of IoU Scores - {dataset_tag}')
plt.xticks(rotation=20)
plt.tight_layout()
plt.savefig(file_vio_iou, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… Violin plots saved successfully:")
print(f"    ğŸ“ Dice Violin Plot â†’ {file_vio_dice}")
print(f"    ğŸ“ IoU  Violin Plot â†’ {file_vio_iou}")
#%%
# ==================================================
# Violin + Box Plot: Dice & IoU
# ==================================================

# ì €ì¥ ê²½ë¡œ ì¤€ë¹„
file_vio_box_dice = get_unique_viz_filename(save_viz_dir, f"vio_box_dice_{tag_slug}")
file_vio_box_iou  = get_unique_viz_filename(save_viz_dir, f"vio_box_iou_{tag_slug}")

# Dice Violin + Box Plot
plt.figure(figsize=(8, 5))
sns.violinplot(
    y='Model', x='Dice', data=df_dice,
    palette=model_palette_1, hue='Model',
    linewidth=0, alpha=0.4, inner=None,
    dodge=False, legend=False
)
sns.boxplot(
    y='Model', x='Dice', data=df_dice,
    palette=model_palette_1, hue='Model',
    width=0.25, fliersize=2, linewidth=1.2,
    dodge=False, legend=False
)
plt.grid(True, linestyle='--', linewidth=0.7, alpha=0.9)
plt.title(f'Violin + Box Plot of Dice Scores - {dataset_tag}')
plt.xlabel('Dice')
plt.ylabel('Model')
plt.tight_layout()
plt.savefig(file_vio_dice, dpi=300)
plt.show()

# IoU Violin + Box  Plot
plt.figure(figsize=(8, 5))
sns.violinplot(
    y='Model', x='IoU', data=df_iou,
    palette=model_palette_2, hue='Model',
    linewidth=0, alpha=0.4, inner=None,
    dodge=False, legend=False
)
sns.boxplot(
    y='Model', x='IoU', data=df_iou,
    palette=model_palette_2, hue='Model',
    width=0.25, fliersize=2, linewidth=1.2,
    dodge=False, legend=False
)
plt.grid(True, linestyle='--', linewidth=0.7, alpha=0.9)
plt.title(f'Violin + Box Plot of Dice Scores - {dataset_tag}')
plt.xlabel('Dice')
plt.ylabel('Model')
plt.tight_layout()
plt.savefig(file_vio_dice, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… Violin + Box plots saved successfully:")
print(f"    ğŸ“ Dice Violin Plot â†’ {file_vio_box_dice}")
print(f"    ğŸ“ IoU  Violin Plot â†’ {file_vio_box_iou}")
#%%
# ==================================================
# Paired Line Plot: Dice & IoU
# ==================================================

# ì €ì¥ ê²½ë¡œ ì§€ì •
file_line_dice = get_unique_viz_filename(save_viz_dir, f"paired_line_dice_{tag_slug}")
file_line_iou  = get_unique_viz_filename(save_viz_dir, f"paired_line_iou_{tag_slug}")

# Dice Paired Line Plot
plt.figure(figsize=(10, 5))

for idx in df_dice['image_index'].unique():
    sample = df_dice[df_dice['image_index'] == idx]
    plt.plot(sample['Model'], sample['Dice'], color='gray', alpha=0.3, linewidth=0.6)

sns.pointplot(
    x='Model', y='Dice', hue='Model', data=df_dice,
    palette=model_palette_1, errorbar='ci', linestyle='none',
    legend=False
)
plt.title(f'Paired Line Plot of Dice Scores - {dataset_tag}')
plt.xticks(rotation=20)
plt.tight_layout()
plt.savefig(file_line_dice, dpi=300)
plt.show()

# IoU Paired Line Plot
plt.figure(figsize=(10, 5))

for idx in df_iou['image_index'].unique():
    sample = df_iou[df_iou['image_index'] == idx]
    plt.plot(sample['Model'], sample['IoU'], color='gray', alpha=0.3, linewidth=0.6)

sns.pointplot(
    x='Model', y='IoU', hue='Model', data=df_iou,
    palette=model_palette_2, errorbar='ci', linestyle='none',
    legend=False
)
plt.title(f'Paired Line Plot of IoU Scores - {dataset_tag}')
plt.xticks(rotation=20)
plt.tight_layout()
plt.savefig(file_line_iou, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… Paired line plots saved successfully:")
print(f"    ğŸ“ Dice Paired Line Plot â†’ {file_line_dice}")
print(f"    ğŸ“ IoU  Paired Line Plot â†’ {file_line_iou}")
#%%
# ==================================================
# ECDF Plot: Dice & IoU
# ==================================================

# ì €ì¥ ê²½ë¡œ ì§€ì •
file_ecdf_dice = get_unique_viz_filename(save_viz_dir, f"ecdf_dice_{tag_slug}")
file_ecdf_iou  = get_unique_viz_filename(save_viz_dir, f"ecdf_iou_{tag_slug}")

# Dice ECDF Plot
plt.figure(figsize=(8, 5))
sns.ecdfplot(data=df_dice, x='Dice', hue='Model', palette=model_palette_1)
plt.title(f'ECDF Plot of Dice Scores - {dataset_tag}')
plt.xlabel('Dice')
plt.ylabel('Cumulative Proportion')
plt.tight_layout()
plt.savefig(file_ecdf_dice, dpi=300)
plt.show()

# IoU ECDF Plot
plt.figure(figsize=(8, 5))
sns.ecdfplot(data=df_iou, x='IoU', hue='Model', palette=model_palette_2)
plt.title(f'ECDF Plot of IoU Scores - {dataset_tag}')
plt.xlabel('IoU')
plt.ylabel('Cumulative Proportion')
plt.tight_layout()
plt.savefig(file_ecdf_iou, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… ECDF plots saved successfully:")
print(f"    ğŸ“ Dice ECDF Plot â†’ {file_ecdf_dice}")
print(f"    ğŸ“ IoU  ECDF Plot â†’ {file_ecdf_iou}")
#%%
# ==================================================
# KDE Plot: Dice & IoU
# ==================================================

# ì €ì¥ ê²½ë¡œ ì§€ì •
file_kde_dice = get_unique_viz_filename(save_viz_dir, f"kde_dice_{tag_slug}")
file_kde_iou  = get_unique_viz_filename(save_viz_dir, f"kde_iou_{tag_slug}")

# Dice KDE Plot
plt.figure(figsize=(8, 5))
for model in df_dice['Model'].unique():
    subset = df_dice[df_dice['Model'] == model]
    sns.kdeplot(subset['Dice'], label=model, linewidth=2, fill=True, alpha=0.3,
                color=model_palette_1.get(model, None))
plt.title(f'KDE Plot of Dice Scores - {dataset_tag}')
plt.xlabel('Dice')
plt.ylabel('Density')
plt.legend()
plt.tight_layout()
plt.savefig(file_kde_dice, dpi=300)
plt.show()

# IoU KDE Plot
plt.figure(figsize=(8, 5))
for model in df_iou['Model'].unique():
    subset = df_iou[df_iou['Model'] == model]
    sns.kdeplot(subset['IoU'], label=model, linewidth=2, fill=True, alpha=0.3,
                color=model_palette_2.get(model, None))
plt.title(f'KDE Plot of IoU Scores - {dataset_tag}')
plt.xlabel('IoU')
plt.ylabel('Density')
plt.legend()
plt.tight_layout()
plt.savefig(file_kde_iou, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… KDE plots saved successfully:")
print(f"    ğŸ“ Dice KDE Plot â†’ {file_kde_dice}")
print(f"    ğŸ“ IoU  KDE Plot â†’ {file_kde_iou}")
#%%
# ==================================================
# Histogram Plot: Dice & IoU
# ==================================================

# ì €ì¥ ê²½ë¡œ ì§€ì •
file_hist_dice = get_unique_viz_filename(save_viz_dir, f"hist_dice_{tag_slug}")
file_hist_iou  = get_unique_viz_filename(save_viz_dir, f"hist_iou_{tag_slug}")

# Dice Histogram
plt.figure(figsize=(8, 5))
for model in df_dice['Model'].unique():
    subset = df_dice[df_dice['Model'] == model]
    sns.histplot(subset['Dice'], label=model, stat='density', bins=50,
                 kde=False, color=model_palette_1.get(model, None),
                 edgecolor='black', alpha=0.35 + 0.1 * (i % 3))
plt.title(f'Histogram of Dice Scores - {dataset_tag}')
plt.xlabel('Dice'); plt.ylabel('Density')
plt.legend(); plt.tight_layout()
plt.savefig(file_hist_dice, dpi=300)
plt.show()

# IoU Histogram
plt.figure(figsize=(8, 5))
for model in df_iou['Model'].unique():
    subset = df_iou[df_iou['Model'] == model]
    sns.histplot(subset['IoU'], label=model, stat='density', bins=50,
                 kde=False, color=model_palette_2.get(model, None),
                 edgecolor='black', alpha=0.35 + 0.1 * (i % 3))
plt.title(f'Histogram of IoU Scores - {dataset_tag}')
plt.xlabel('IoU'); plt.ylabel('Density')
plt.legend(); plt.tight_layout()
plt.savefig(file_hist_iou, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… Histogram plots saved successfully:")
print(f"    ğŸ“ Dice Histogram Plot â†’ {file_hist_dice}")
print(f"    ğŸ“ IoU  Histogram Plot â†’ {file_hist_iou}")
#%%
# ==================================================
# Histogram + KDE Plot: Dice & IoU
# ==================================================

# ì €ì¥ ê²½ë¡œ ì§€ì •
file_hist_kde_dice = get_unique_viz_filename(save_viz_dir, f"hist_kde_dice_{tag_slug}")
file_hist_kde_iou  = get_unique_viz_filename(save_viz_dir, f"hist_kde_iou_{tag_slug}")

# Dice Histogram
plt.figure(figsize=(8, 5))
for model in df_dice['Model'].unique():
    subset = df_dice[df_dice['Model'] == model]
    sns.histplot(subset['Dice'], label=model, stat='density', bins=50,
                 kde=False, color=model_palette_1.get(model, None),
                 edgecolor='black', alpha=0.35 + 0.1 * (i % 3))
    sns.kdeplot(
        subset['Dice'],
        color=model_palette_1[model],
        lw=2, alpha=0.9
    )
plt.title(f'Histogram + KDE of Dice Scores - {dataset_tag}')
plt.xlabel('Dice'); plt.ylabel('Density')
plt.legend(); plt.tight_layout()
plt.savefig(file_hist_dice, dpi=300)
plt.show()

# IoU Histogram
plt.figure(figsize=(8, 5))
for model in df_iou['Model'].unique():
    subset = df_iou[df_iou['Model'] == model]
    sns.histplot(subset['IoU'], label=model, stat='density', bins=50,
                 kde=False, color=model_palette_2.get(model, None),
                 edgecolor='black', alpha=0.35 + 0.1 * (i % 3))
    sns.kdeplot(
        subset['IoU'],
        color=model_palette_2[model],
        lw=2, alpha=0.9
    )
plt.title(f'Histogram + KDE of IoU Scores - {dataset_tag}')
plt.xlabel('IoU'); plt.ylabel('Density')
plt.legend(); plt.tight_layout()
plt.savefig(file_hist_iou, dpi=300)
plt.show()

# ì €ì¥
print("\n\nâœ… Histogram + KDE plots saved successfully:")
print(f"    ğŸ“ Dice Histogram Plot â†’ {file_hist_kde_dice}")
print(f"    ğŸ“ IoU  Histogram Plot â†’ {file_hist_kde_iou}")
